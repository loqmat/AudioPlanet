<!doctype html>
<html>
<head>
    <title> Computer Graphics Project </title>
    
    <script id="box-vshader" type="x-shader/x-vertex">
        uniform mat4 uProjection; 
        uniform mat4 uModelView;
        attribute vec2 vPosition;

        void
        main()
        {
            gl_Position = uProjection * uModelView * vec4(vPosition,0,1);
        }
    </script>
    <script id="box-fshader" type="x-shader/x-fragment">
        precision mediump float;
        uniform vec4 uColor;

        void
        main()
        {
            gl_FragColor = uColor;
        }
    </script>    
    
    <script id="wave-vshader" type="x-shader/x-vertex">
        attribute vec2 vPosition;

        void
        main()
        {
            gl_Position = vec4(vPosition,0,1);
            gl_PointSize = 4.0;
        }
    </script>
    <script id="wave-fshader" type="x-shader/x-fragment">
        precision mediump float;
        uniform vec4 uColor;

        void
        main()
        {
            gl_FragColor = uColor;
        }
    </script>
    
    <script id="sphere-vshader" type="x-shader/x-vertex">
        #define M_PI 3.1415926535897932384626433832795
        uniform float audioData[AUDIO_ELEMENTS];
        uniform float audioImpulse[AUDIO_ELEMENTS];
        uniform vec3 audioBumps[AUDIO_ELEMENTS];
        uniform vec3 normalGradientColors[4];
        uniform vec3 impulseGradientColors[4];
        uniform mat4 modelViewMatrix;
        uniform mat4 projectionMatrix;
        uniform mat3 normalMatrix;
        attribute vec2 vPosition;
        attribute vec2 vUV;
        varying float fCombine;
        varying vec2 fUV;
        varying vec3 fNormal;
        varying vec3 fColor;
        void main()
        {
            float theta = vPosition.x;
            float phi = vPosition.y;
            float cosTheta = cos(theta);
            float sinTheta = sin(theta);
            float cosPhi = cos(phi);
            float sinPhi = sin(phi);
            vec3 position = normalize(vec3(cosPhi * sinTheta, cosTheta, sinPhi * sinTheta));
            fCombine = 0.0;
            float h = 0.5;
            float gauss_scale = float(AUDIO_ELEMENTS)/4.0;
            for ( int i=0;i<AUDIO_ELEMENTS;i++ ) {
                float distance = acos(clamp(dot(position, audioBumps[i]),-1.0,1.0)) / M_PI;
                float gauss = exp2(-gauss_scale*distance*distance);
                float height = audioData[i] * gauss;
                h += (100.0 * height * height) / 10.0;
                fCombine += audioImpulse[i] * gauss;
            }
            fCombine /= 10.0;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position * h, 1);
            gl_PointSize = 16.0 / (1.0+gl_Position.z*gl_Position.z);
            fUV = vUV;
            fNormal = position;
            float A = 1.0 - clamp(abs(h-0.0), 0.0, 1.0);
            float B = 1.0 - clamp(abs(h-1.0), 0.0, 1.0);
            float C = 1.0 - clamp(abs(h-2.0), 0.0, 1.0);
            float D = 1.0 - clamp(abs(h-3.0), 0.0, 1.0);
            float E = A + B + C + D;
            vec3 normalColor = normalGradientColors[0] * A / E + 
                               normalGradientColors[1] * B / E + 
                               normalGradientColors[2] * C / E + 
                               normalGradientColors[3] * D / E;
            vec3 impulseColor = impulseGradientColors[0] * A / E + 
                                impulseGradientColors[1] * B / E + 
                                impulseGradientColors[2] * C / E + 
                                impulseGradientColors[3] * D / E;
            fColor = fCombine * impulseColor + (1.0-fCombine) * normalColor;
        }
    </script>
    
    <script id="sphere-fshader" type="x-shader/x-fragment">
        precision mediump float;
        varying float fCombine;
        varying vec2 fUV;
        varying vec3 fNormal;
        varying vec3 fColor;
        
        uniform vec3 uLightDirection;
        uniform vec4 uColor;

        void
        main()
        {
            float stren = clamp(dot(uLightDirection, fNormal), 0.0, 1.0);
            gl_FragColor = fCombine * vec4(fColor.rgb,1) + (1.0-fCombine) * vec4(fColor.rgb * stren, 1);
        }
    </script>
    
    <script type="text/javascript" src="./lib/webgl-utils.js"></script>
    <script type="text/javascript" src="./lib/initShaders.js"></script>
    <script type="text/javascript" src="./lib/MV.js"></script>
    <script type="text/javascript" src="./generateSphere.js"></script>
    <script type="text/javascript" src="./main.js"></script>
    <link rel="stylesheet" type="text/css" href="main.css">
</head>
<body>
    <input id="loadFile" type="file"/>
    <canvas id="GLCanvas">
        Oops ... your browser doesn't support the HTML5 canvas element
    </canvas>
</body>
</html>